---
title: "Nhom-06_Bao-cao-cuoi-ky"
author: "Nhom 06"
date: "2023-12-12"
output:   
  html_document:
    df_print: paged
---

# 1. Gi·ªõi thi·ªáu

**B·ªëi c·∫£nh:**

Th∆∞·ªùng th√¨ c√°c b·ªô d·ªØ li·ªáu th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠ l√† t√†i s·∫£n ri√™ng v√† do ƒë√≥ kh√≥ t√¨m th·∫•y trong s·ªë c√°c d·ªØ li·ªáu c√≥ s·∫µn c√¥ng khai. Tuy nhi√™n, B·ªô l∆∞u tr·ªØ H·ªçc m√°y c·ªßa ƒê·∫°i h·ªçc California, Irvine ([UCI Machine Learning Repository](http://archive.ics.uci.edu/)) ƒë√£ cung c·∫•p b·ªô d·ªØ li·ªáu n√†y ch·ª©a c√°c giao d·ªãch th·ª±c t·∫ø t·ª´ nƒÉm 2010 v√† 2011. B·ªô d·ªØ li·ªáu ƒë∆∞·ª£c duy tr√¨ tr√™n trang web c·ªßa h·ªç, n∆°i c√≥ th·ªÉ t√¨m th·∫•y b·ªô d·ªØ li·ªáu b·∫±ng ti√™u ƒë·ªÅ "[Online Retail](http://archive.ics.uci.edu/dataset/352/online+retail)". Theo UCI Machine Learning Repository, d·ªØ li·ªáu n√†y ƒë√£ ƒë∆∞·ª£c cung c·∫•p b·ªüi Ti·∫øn sƒ© Daqing Chen, Gi√°m ƒë·ªëc nh√≥m Ph√¢n t√≠ch C√¥ng c·ªông.

**N·ªôi dung:**

ƒê√¢y l√† m·ªôt b·ªô d·ªØ li·ªáu qu·ªëc t·∫ø ch·ª©a t·∫•t c·∫£ c√°c giao d·ªãch di·ªÖn ra t·ª´ 01/12/2010 ƒë·∫øn 09/12/2011 cho m·ªôt doanh nghi·ªáp b√°n l·∫ª tr·ª±c tuy·∫øn kh√¥ng c√≥ c·ª≠a h√†ng ·ªü t·∫°i V∆∞∆°ng Qu·ªëc Anh v√† ƒë∆∞·ª£c ƒëƒÉng k√Ω. C√¥ng ty ch·ªß y·∫øu b√°n c√°c s·∫£n ph·∫©m qu√† t·∫∑ng ƒë·ªôc ƒë√°o ph√π h·ª£p cho m·ªçi d·ªãp. Nhi·ªÅu kh√°ch h√†ng c·ªßa c√¥ng ty l√† c√°c nh√† bu√¥n, b√°n s·ªâ.

# 2. Chu·∫©n b·ªã d·ªØ li·ªáu

**Chu·∫©n b·ªã c√°c th∆∞ vi·ªán c·∫ßn thi·∫øt**

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(plotly)
library(ggplot2)
library(tokenizers)
library(udpipe)
library(SnowballC)
library(cluster)
library(wordcloud2)
library(lubridate)
library(fmsb)
library(prophet)
library(caret)
library(readr)
library(rpart)
library(randomForest)

set.seed(21133)
# ^--- Th√™m c√°c th∆∞ vi·ªán m·ªõi v√†o ƒë√¢y
```

ƒê·ªçc file .csv

```{r}
df_raw <- read.csv('data.csv', encoding = "ISO-8859-1", stringsAsFactors = FALSE)
head(df_raw, 5)
```

```{r}
df_initial <- df_raw
df_initial[order(df_initial$CustomerID), ]
```

*V√¨ h√†m is.na() c√≥ s·∫µn kh√¥ng th·ªÉ ƒë·∫øm ƒë∆∞·ª£c c√°c gi√° tr·ªã \<chr\> r·ªóng "" n√™n nh√≥m ƒë√£ thi·∫øt k·∫ø m·ªôt function ƒë·ªÉ ƒë·∫øn c√°c gi√° tr·ªã null, NaN c≈©ng nh∆∞ c√°c gi√° tr·ªã ""*

```{r}
isNA_new <- function(value) {
  result <- ifelse(is.na(value) | is.null(value), TRUE,
            ifelse(value == "", TRUE,
            FALSE))
  return(result)
}
```

M√¥ t·∫£ c∆° b·∫£n v·ªÅ d·ªØ li·ªáu: ki·ªÉu d·ªØ li·ªáu c·ªßa c√°c c·ªôt, s·ªë l∆∞·ª£ng gi√° tr·ªã null v√† t·ªâ l·ªá ph·∫ßn trƒÉm so v·ªõi s·ªë l∆∞·ª£ng gi√° tr·ªã c·ªßa c√°c c·ªôt

```{r}
cat("Dataframe dimensions:", dim(df_initial), "\n")

column_info <- function(df) {
  tab_info <- data.frame(
    column_type = sapply(df, class),
    null_values_nb = colSums(isNA_new(df)),
    null_values_percent = colMeans(isNA_new(df)) * 100
  )
  return(tab_info)
}

tab_info <- column_info(df_initial)
print(tab_info)
```

V√¨ c√≥ kho·∫£ng 25% record kh√¥ng ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh cho m·ªôt kh√°ch h√†ng c·ª• th·ªÉ. V·ªõi d·ªØ li·ªáu c√≥ s·∫µn, kh√¥ng th·ªÉ √°p ƒë·∫∑t c√°c gi√° tr·ªã cho ng∆∞·ªùi d√πng v√† do ƒë√≥, c√°c record n√†y kh√¥ng c√≥ √Ω nghƒ©a ƒë·ªëi v·ªõi ph√¢n t√≠ch hi·ªán t·∫°i. V√¨ v·∫≠y, nh√≥m quy·∫øt ƒë·ªãnh x√≥a ch√∫ng kh·ªèi dataframe

```{r}
df_initial <- na.omit(df_initial, cols = "CustomerID")

cat("Dataframe dimensions:", dim(df_initial), "\n")
tab_info <- column_info(df_initial)
print(tab_info)
```

Sau khi x·ª≠ l√Ω c√°c d√≤ng d·ªØ li·ªáu null, ta ki·ªÉm tra c√°c d√≤ng d·ªØ li·ªáu tr√πng nhau v√† x·ª≠ l√Ω ch√∫ng b·∫±ng c√°ch lo·∫°i b·ªè

```{r}
cat("Duplicate entries: ", sum(duplicated(df_initial)), "\n")
# Lo·∫°i m·∫•y d√≤ng tr√πng
df_initial <- df_initial[!duplicated(df_initial), ]
```

Cu·ªëi c√πng, ta chuy·ªÉn ƒë·ªïi c√°c ki·ªÉu d·ªØ li·ªáu c·ªßa t·ª´ng c·ªôt sao cho h·ª£p l√Ω Chuy·ªÉn ki·ªÉu d·ªØ li·ªáu c·ªßa c·ªôt InvoiceDate th√†nh d·∫°ng th·ªùi gian <date>, chuy·ªÉn ki·ªÉu d·ªØ li·ªáu c·ªßa c·ªôt CustomerID th√†nh d·∫°ng <chr>

```{r}
df_initial$InvoiceDate <- as.POSIXct(df_initial$InvoiceDate, format = "%m/%d/%Y %H:%M")
df_initial$CustomerID <- as.character(df_initial$CustomerID)
```

Sau khi qu√° tr√¨nh chu·∫©n b·ªã d·ªØ li·ªáu ho√†n t·∫•t, ta c√≥ m·ªôt t·∫≠p d·ªØ li·ªáu t∆∞∆°ng ƒë·ªëi ho√†n ch·ªânh

```{r}
print(dim(df_initial))
df_initial
```

# 3. Khai ph√° d·ªØ li·ªáu

Khung d·ªØ li·ªáu n√†y ch·ª©a 8 bi·∫øn t∆∞∆°ng ·ª©ng v·ªõi:

-   InvoiceNo: S·ªë h√≥a ƒë∆°n - m·ªôt chu·ªói c√≥ m√¥ t·∫£ nh∆∞ sau: s·ªë nguy√™n g·ªìm 6 ch·ªØ s·ªë ƒë∆∞·ª£c g√°n duy nh·∫•t cho m·ªói giao d·ªãch. N·∫øu m√£ n√†y b·∫Øt ƒë·∫ßu b·∫±ng ch·ªØ c√°i 'c' th√¨ n√≥ bi·ªÉu th·ªã vi·ªác h·ªßy.

-   StockCode: M√£ s·∫£n ph·∫©m (m·∫∑t h√†ng) - m·ªôt chu·ªói c√≥ m√¥ t·∫£ nh∆∞ sau: m·ªôt s·ªë nguy√™n g·ªìm 5 ch·ªØ s·ªë ƒë∆∞·ª£c g√°n duy nh·∫•t cho t·ª´ng s·∫£n ph·∫©m ri√™ng bi·ªát.

-   Description: T√™n s·∫£n ph·∫©m (m·∫∑t h√†ng).

-   Quantity: S·ªë l∆∞·ª£ng c·ªßa t·ª´ng s·∫£n ph·∫©m (m·∫∑t h√†ng) tr√™n m·ªói giao d·ªãch.

-   InvoiceDate: Ng√†y v√† gi·ªù l·∫≠p h√≥a ƒë∆°n. S·ªë, ng√†y v√† gi·ªù m·ªói giao d·ªãch ƒë∆∞·ª£c t·∫°o.

-   UnitPrice: ƒê∆°n gi√° - m·ªôt s·ªë th·ª±c: Gi√° s·∫£n ph·∫©m tr√™n m·ªói ƒë∆°n v·ªã b·∫±ng ƒë·ªìng b·∫£ng Anh.

-   CustomerID: M√£ s·ªë kh√°ch h√†ng - m·ªôt chu·ªói c√≥ m√¥ t·∫£ nh∆∞ sau: m·ªôt s·ªë nguy√™n g·ªìm 5 ch·ªØ s·ªë ƒë∆∞·ª£c g√°n duy nh·∫•t cho m·ªói kh√°ch h√†ng.

-   Country: T√™n qu·ªëc gia: t√™n qu·ªëc gia n∆°i m·ªói kh√°ch h√†ng c∆∞ tr√∫.

## 3.1. Qu·ªëc gia

Xem nhanh c√°c qu·ªëc gia th·ª±c hi·ªán ƒë∆°n h√†ng

```{r}
# Group 'CustomerID', 'InvoiceNo', 'Country'
temp <- df_initial %>%
  group_by(CustomerID, InvoiceNo, Country) %>%
  summarise(count = n(), .groups = 'drop') %>%
  ungroup()

# ƒê·∫øm c√°c qu·ªëc gia
countries <- temp %>% 
  count(Country) 
cat("Number of country: ", length(countries$Country), "\n")
```

V·∫Ω b·∫£n ƒë·ªì th·ªëng k√™ chloropleth map

```{r}
data <- list(
  type = "choropleth",
  locations = countries$Country,
  locationmode = "country names",
  z = countries$n,
  text = countries$Country,
  colorbar = list(title = "Order nb."),
  colorscale = list(
    c(0, "rgb(224,255,255)"),
    c(0.01, "rgb(166,206,227)"),
    c(0.02, "rgb(31,120,180)"),
    c(0.03, "rgb(178,223,138)"),
    c(0.05, "rgb(51,160,44)"),
    c(0.10, "rgb(251,154,153)"),
    c(0.20, "rgb(255,255,0)"),
    c(1, "rgb(227,26,28)")
  ),
  reversescale = FALSE
)

layout <- list(
  title = "Number of orders per country",
  geo = list(showframe = TRUE, projection = list(type = "mercator"))
)

choromap <- plot_ly(z = countries$n, locations = countries$Country, type = "choropleth", locationmode = "country names") %>%
  layout(title = "Number of orders per country", geo = list(showframe = TRUE, projection = list(type = "mercator")))
choromap
```

Ta c√≥ th·ªÉ th·∫•y r·∫±ng t·∫≠p d·ªØ li·ªáu ph·∫ßn l·ªõn b·ªã chi ph·ªëi b·ªüi c√°c ƒë∆°n ƒë·∫∑t h√†ng ƒë∆∞·ª£c th·ª±c hi·ªán t·ª´ V∆∞∆°ng qu·ªëc Anh. (x·∫•p x·ªâ 20/400 ngh√¨n ƒë∆°n)

## 3.2. Kh√°ch h√†ng v√† S·∫£n ph·∫©m

Dataframe ch·ª©a kho·∫£ng 400.000 record. V·∫≠y c√≥ bao nhi√™u kh√°ch h√†ng, s·∫£n ph·∫©m v√† ƒë∆°n h√†ng trong dataframe n√†y?

```{r}
quantity <- data.frame(
  products = length(unique(df_initial$StockCode)),
  transactions = length(unique(df_initial$InvoiceNo)),
  customers = length(unique(df_initial$CustomerID))
)
rownames(quantity) <- "quantity"
quantity
```

C√≥ th·ªÉ th·∫•y r·∫±ng d·ªØ li·ªáu c√≥ 4372 kh√°ch h√†ng v√† h·ªç ƒë√£ mua 3684 s·∫£n ph·∫©m kh√°c nhau. T·ªïng s·ªë ƒë∆°n h√†ng ƒë∆∞·ª£c th·ª±c hi·ªán v√†o kho·∫£ng 22000 ƒë∆°n.

Nh√≥m s·∫Ω ti·∫øp t·ª•c x√°c ƒë·ªãnh s·ªë l∆∞·ª£ng s·∫£n ph·∫©m mua trong m·ªói ƒë∆°n h√†ng:

```{r}
# Group 'CustomerID', 'InvoiceNo', ƒë·∫øm s·ªë l·∫ßn xu·∫•t hi·ªán c·ªßa 'InvoiceDate'
temp <- df_initial %>%
  group_by(CustomerID, InvoiceNo) %>%
  summarise(`Number of products` = n(), .groups = 'drop')

nb_products_per_basket <- temp %>%
  arrange(CustomerID)
nb_products_per_basket
```

T·ª´ t·∫≠p d·ªØ li·ªáu tr√™n, ta c√≥ th·ªÉ th·∫•y:

-   Ti·ªÅn t·ªë C cho bi·∫øn InvoiceNo cho bi·∫øt c√°c ƒë∆°n h√†ng ƒë√£ b·ªã h·ªßy.

-   C√≥ nh·ªØng kh√°ch h√†ng ch·ªâ ƒë·∫øn mua m·ªôt l·∫ßn v√† ch·ªâ mua m·ªôt s·∫£n ph·∫©m (v√≠ d·ª•: s·ªë 12346).

-   C√≥ nh·ªØng kh√°ch h√†ng th∆∞·ªùng xuy√™n mua s·ªë l∆∞·ª£ng l·ªõn c√°c m·∫∑t h√†ng trong m·ªói ƒë∆°n h√†ng.

### 3.2.1. C√°c ƒë∆°n h√†ng b·ªã hu·ª∑

```{r}
nb_products_per_basket$order_canceled <- as.integer(grepl("C", nb_products_per_basket$InvoiceNo))
nb_products_per_basket

n1 <- sum(nb_products_per_basket$order_canceled)
n2 <- nrow(nb_products_per_basket)
cat(sprintf("Number of orders canceled: %d/%d (%.2f%%) \n", n1, n2, n1/n2*100))
```

C√≥ th·ªÉ th·∫•y s·ªë l∆∞·ª£ng ƒë∆°n h√†ng b·ªã hu·ª∑ c≈©ng kh√° l√† nhi·ªÅu (kho·∫£ng 16% tr√™n t·ªïng s·ªë ƒë∆°n)

```{r}
df_initial_sorted <- df_initial %>%
  arrange(CustomerID) %>%
  head(5)
df_initial_sorted
```

·ªû m·ªôt v√†i d√≤ng d·ªØ li·ªáu tr√™n, ta c√≥ th·ªÉ th·∫•y r·∫±ng khi m·ªôt ƒë∆°n h√†ng b·ªã h·ªßy, ta s·∫Ω c√≥ m·ªôt ƒë∆°n h√†ng kh√°c trong dataframe, h·∫ßu h·∫øt gi·ªëng h·ªát nhau ngo·∫°i tr·ª´ c√°c bi·∫øn v·ªÅ S·ªë l∆∞·ª£ng v√† Ng√†y l·∫≠p h√≥a ƒë∆°n. Nh√≥m s·∫Ω quy·∫øt ƒë·ªãnh ki·ªÉm tra xem ƒëi·ªÅu n√†y c√≥ ƒë√∫ng v·ªõi t·∫•t c·∫£ c√°c record kh√¥ng.

ƒê·ªÉ l√†m ƒëi·ªÅu n√†y, nh√≥m s·∫Ω t√¨m c√°c record c√≥ ch·ª©a s·ªë l∆∞·ª£ng √¢m (trong c·ªôt Quantity) v√† ki·ªÉm tra xem c√≥ m·ªôt ƒë∆°n h√†ng n√†o ch·ªâ ra c√πng m·ªôt s·ªë l∆∞·ª£ng m·ªôt c√°ch h·ªá th·ªëng (nh∆∞ng d∆∞∆°ng), v·ªõi c√πng m·ªôt m√¥ t·∫£ (ID kh√°ch h√†ng, M√¥ t·∫£ v√† ƒê∆°n gi√°) hay kh√¥ng:

```{r}
df_check <- df_initial %>%
  filter(Quantity < 0) %>%
  select(CustomerID, Quantity, StockCode, Description, UnitPrice)

for (i in 1:nrow(df_check)) {
  row <- df_check[i, ]
  cond <- df_initial %>%
    filter(
      CustomerID == row$CustomerID,
      Quantity == -row$Quantity,
      Description == row$Description
    )
  
  if (nrow(cond) == 0) {
    print(row)
    cat("-----> HYPOTHESIS NOT FULFILLED\n")
    # gi·∫£ thi·∫øt kh√¥ng ho√†n th√†nh
    break
  }
}
```

Ta th·∫•y r·∫±ng gi·∫£ thuy·∫øt ban ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c ƒë√°p ·ª©ng do s·ª± t·ªìn t·∫°i c·ªßa m·ª•c 'Discount'. Nh√≥m s·∫Ω th·ª±c hi·ªán ki·ªÉm tra l·∫°i gi·∫£ thuy·∫øt nh∆∞ng l·∫ßn n√†y lo·∫°i b·ªè m·ª•c 'Discount':

```{r}
df_check <- df_initial %>%
  filter(Quantity < 0 & Description != 'Discount') %>%
  select(CustomerID, Quantity, StockCode, Description, UnitPrice)

for (i in 1:nrow(df_check)) {
  row <- df_check[i, ]
  cond <- df_initial %>%
    filter(
      CustomerID == row$CustomerID,
      Quantity == -row$Quantity,
      Description == row$Description
    )
  
  if (nrow(cond) == 0) {
    print(row)
    cat("-----> HYPOTHESIS NOT FULFILLED\n")
    # gi·∫£ thi·∫øt kh√¥ng ho√†n th√†nh
    break
  }
}
```

M·ªôt l·∫ßn n·ªØa, ta th·∫•y r·∫±ng gi·∫£ thuy·∫øt ban ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c x√°c minh. Do ƒë√≥, vi·ªác h·ªßy b·ªè ƒë∆°n h√†ng kh√¥ng nh·∫•t thi·∫øt ph·∫£i t∆∞∆°ng ·ª©ng v·ªõi c√°c ƒë∆°n ƒë·∫∑t h√†ng ƒë√£ ƒë∆∞·ª£c th·ª±c hi·ªán tr∆∞·ªõc ƒë√≥.

ƒê·ªëi v·ªõi nh·ªØng l·∫ßn h·ªßy kh√¥ng c√≥ ƒë·ªëi t√°c, m·ªôt s·ªë trong s·ªë ƒë√≥ c√≥ th·ªÉ l√† do l·ªánh mua ƒë∆∞·ª£c th·ª±c hi·ªán tr∆∞·ªõc th√°ng 12 nƒÉm 2010 (th·ªùi ƒëi·ªÉm nh·∫≠p c∆° s·ªü d·ªØ li·ªáu). Nh√≥m s·∫Ω ti·∫øp t·ª•c th·ª±c hi·ªán ki·ªÉm tra c√°c ƒë∆°n h√†ng h·ªßy v√† ki·ªÉm tra s·ª± t·ªìn t·∫°i c·ªßa c√°c ƒë∆°n h√†ng t∆∞∆°ng ·ª©ng:

```{r}
df_cleaned <- df_initial
df_cleaned$QuantityCanceled <- as.integer(0)
```

```{r warning=FALSE}
entry_to_remove <- c()
doubtful_entry <- c()

for (i in 1:nrow(df_initial)) {
  col <- df_initial[i, ]
  if ((df_initial[i, "Quantity"] > 0) || (df_initial[i, "Description"] == "Discount")) next
  
  df_test <- subset(df_initial, 
                    CustomerID == df_initial[i, "CustomerID"] & 
                    StockCode == df_initial[i, "StockCode"] & 
                    InvoiceDate < df_initial[i, "InvoiceDate"] & 
                    Quantity > 0)
  
  if (nrow(df_test) == 0) {
    doubtful_entry <- c(doubtful_entry, i)
  } 
  else if (nrow(df_test) == 1) {
    df_cleaned[rownames(df_test)[1], "QuantityCanceled"] <- -col['Quantity']
    entry_to_remove <- c(entry_to_remove, i)
  } 
  else if (nrow(df_test) > 1) {
    df_test <- df_test[order(-as.numeric(rownames(df_test))), ]
    for (j in 1:nrow(df_test)) {
      val <- df_test[j, ]
      if (val['Quantity'] < -col['Quantity']) next
      df_cleaned[rownames(df_test)[j], 'QuantityCanceled'] <- -col['Quantity']
      entry_to_remove <- c(entry_to_remove, i)
      break
    }
  }
}
```

Trong ƒëo·∫°n code tr√™n, nh√≥m ƒë√£ ki·ªÉm tra hai tr∆∞·ªùng h·ª£p:

-   l·ªánh h·ªßy t·ªìn t·∫°i m√† kh√¥ng c√≥ ƒë∆°n ƒë·∫∑t

-   c√≥ √≠t nh·∫•t m·ªôt b·∫£n sao c·ªßa ho√° ƒë∆°n c√≥ c√πng s·ªë l∆∞·ª£ng v·ªõi nhau

Ch·ªâ m·ª•c c·ªßa l·ªánh h·ªßy t∆∞∆°ng ·ª©ng ƒë∆∞·ª£c gi·ªØ l·∫ßn l∆∞·ª£t trong doubtful_entry (c√°c d√≤ng d·ªØ li·ªáu nghi ng·ªù) v√† entry_to_remove (c√°c d√≤ng d·ªØ li·ªáu lo·∫°i b·ªè) s·∫Ω c√≥ k√≠ch th∆∞·ªõc l√†:

```{r}
cat("entry_to_remove: ", length(entry_to_remove), "\n")
cat("doubtful_entry: ", length(doubtful_entry), "\n")
```

```{r}
# Lo·∫°i b·ªè c√°c d√≤ng ƒë∆∞·ª£c ch·ªçn trong entry_to_remove v√† doubtful_entry
df_cleaned <- df_cleaned[-c(entry_to_remove, doubtful_entry), , drop = FALSE]

remaining_entries <- subset(df_cleaned, Quantity < 0 & StockCode != 'D')

cat("Entries to delete: ", nrow(remaining_entries), "\n")
remaining_entries
```

### 3.2.2. Gi√° s·∫£n ph·∫©m k√®m theo giao d·ªãch

Nh√≥m s·∫Ω t·∫°o m·ªôt bi·∫øn m·ªõi cho bi·∫øt t·ªïng gi√° c·ªßa m·ªói l·∫ßn mua h√†ng:

```{r}
# t·ªïng ti·ªÅn mua = ƒë∆°n gi√° * (ƒë∆°n v·ªã mua - ƒë∆°n v·ªã hu·ª∑ ƒë∆°n mua)
df_cleaned$TotalPrice <- df_cleaned$UnitPrice * (df_cleaned$Quantity - df_cleaned$QuantityCanceled)

df_cleaned_f <- distinct(df_cleaned) # t·∫°o dataframe df_cleaned_f ƒë·ªÉ d√πng cho ph·∫ßn 4.3 v√† ph·∫ßn 5

df_cleaned[order(df_cleaned$CustomerID), ]
```

M·ªói d√≤ng trong dataframe ƒë·ªÅ c·∫≠p ƒë·∫øn gi√° c·ªßa m·ªôt lo·∫°i s·∫£n ph·∫©m duy nh·∫•t. Do ƒë√≥, c√°c ƒë∆°n ƒë·∫∑t h√†ng ƒë∆∞·ª£c chia th√†nh nhi·ªÅu d√≤ng. Nh√≥m thu th·∫≠p t·∫•t c·∫£ c√°c mua h√†ng ƒë∆∞·ª£c th·ª±c hi·ªán trong m·ªôt ƒë∆°n ƒë·∫∑t h√†ng duy nh·∫•t ƒë·ªÉ t√≠nh t·ªïng gi√° tr·ªã c·ªßa ƒë∆°n h√†ng:

```{r}
temp <- aggregate(TotalPrice ~ CustomerID + InvoiceNo, data = df_cleaned, sum)
colnames(temp)[3] <- "Basket Price"
basket_price <- temp

df_cleaned$InvoiceDate_int <- as.integer(as.POSIXct(df_cleaned$InvoiceDate))
temp <- aggregate(InvoiceDate_int ~ CustomerID + InvoiceNo, data = df_cleaned, mean)
df_cleaned <- subset(df_cleaned, select = -InvoiceDate_int)
basket_price$InvoiceDate <- as.POSIXct(as.integer(temp$InvoiceDate_int), origin="1970-01-01")

basket_price <- subset(basket_price, basket_price$`Basket Price` > 0)
basket_price[order(basket_price$CustomerID), ]
```

```{r}
price_range <- c(0, 50, 100, 200, 500, 1000, 5000, 50000)
count_price <- c()

for (i in 1:length(price_range)) {
  if (i == 1) next
  val <- sum(basket_price$`Basket Price` < price_range[i] & basket_price$`Basket Price` > price_range[i-1])
  count_price <- c(count_price, val)
}

df <- data.frame(
  Muc_gia = sapply(2:length(price_range), function(i) paste(price_range[i-1], "<.<", price_range[i])),
  sizes = count_price
)

# T√≠nh ph·∫ßn trƒÉm
df$percentages <- df$sizes / sum(df$sizes) * 100

# V·∫Ω bi·ªÉu ƒë·ªì tr√≤n v·ªõi ch√∫ th√≠ch ph·∫ßn trƒÉm
ggplot(df, aes(x = "", y = sizes, fill = Muc_gia)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  geom_text(aes(label = paste(round(percentages, 1), "%")), position = position_stack(vjust = 0.5)) +
  theme_void() +
  labs(title = "Ph√¢n ph·ªëi s·ªë ti·ªÅn c·ªßa c√°c ƒë∆°n ƒë·∫∑t h√†ng")
```

C√≥ th·ªÉ th·∫•y r·∫±ng ph·∫ßn l·ªõn c√°c ƒë∆°n ƒë·∫∑t h√†ng li√™n quan ƒë·∫øn c√°c giao d·ªãch mua t∆∞∆°ng ƒë·ªëi l·ªõn v√¨ c√≥ kho·∫£ng 65% s·ªë l·∫ßn mua h√†ng c√≥ gi√° tr·ªã v∆∞·ª£t qu√° 200 ¬£.

# 4. Th√¥ng tin chi ti·∫øt v·ªÅ c√°c danh m·ª•c s·∫£n ph·∫©m

Trong dataframe, c√°c s·∫£n ph·∫©m ƒë∆∞·ª£c x√°c ƒë·ªãnh duy nh·∫•t th√¥ng qua c·ªôt StockCode. M√¥ t·∫£ ng·∫Øn g·ªçn c·ªßa c√°c s·∫£n ph·∫©m ƒë∆∞·ª£c cung c·∫•p trong c·ªôt Description. Trong ph·∫ßn n√†y, nh√≥m s·ª≠ d·ª•ng 2 c·ªôt ƒë∆∞·ª£c n√™n tr√™n ƒë·ªÉ nh√≥m c√°c s·∫£n ph·∫©m th√†nh c√°c danh m·ª•c kh√°c nhau.

## 4.1. Nh·ªØng s·∫£n ph·∫©m ƒë∆∞·ª£c mua nhi·ªÅu nh·∫•t

L∆∞u √Ω: kh√¥ng t√≠nh c√°c ƒë∆°n h√†ng ƒë√£ hu·ª∑

```{r}
df_cleaned %>% 
  group_by(StockCode, Description) %>% 
  summarise(count = n(), .groups = 'drop') %>% 
  arrange(desc(count)) %>% 
  head() %>%
  ggplot(aes(x = Description, y = count, fill = count)) + 
    geom_bar(stat = "identity") + coord_flip() +
    labs(y = "S·ªë l∆∞·ª£ng s·∫£n ph·∫©n mua", x = "T√™n s·∫£n ph·∫©m")
```

## 4.2. M√¥ t·∫£ s·∫£n ph·∫©m - Description

B∆∞·ªõc ƒë·∫ßu ti√™n, nh√≥m s·∫Ω tr√≠ch xu·∫•t th√¥ng tin t·ª´ c·ªôt Description:

Thu th·∫≠p danh s√°ch c√°c s·∫£n ph·∫©m:

```{r}
df_produits <- data.frame(Description = unique(df_initial$Description))
df_produits
```

H√†m n√†y nh·∫≠n b·∫£ng d·ªØ li·ªáu l√†m ƒë·∫ßu v√†o v√† ph√¢n t√≠ch n·ªôi dung c·ªßa c·ªôt Description b·∫±ng c√°ch th·ª±c hi·ªán c√°c thao t√°c sau:

-   Tr√≠ch xu·∫•t c√°c t√™n (t√™n ri√™ng, ph·ªï th√¥ng) xu·∫•t hi·ªán trong m√¥ t·∫£ s·∫£n ph·∫©m
-   ƒê·ªëi v·ªõi m·ªói t√™n, t√¥i tr√≠ch xu·∫•t g·ªëc c·ªßa t·ª´ v√† t·ªïng h·ª£p t·∫≠p h·ª£p c√°c t√™n ƒë∆∞·ª£c li√™n k·∫øt v·ªõi g·ªëc t·ª´ c·ª• th·ªÉ n√†y
-   ƒê·∫øm s·ªë l·∫ßn xu·∫•t hi·ªán c·ªßa m·ªói g·ªëc t·ª´ trong b·∫£ng d·ªØ li·ªáu
-   Khi c√≥ nhi·ªÅu t·ª´ ƒë∆∞·ª£c li·ªát k√™ cho c√πng m·ªôt g·ªëc t·ª´, t√¥i coi t·ª´ kh√≥a ƒë∆∞·ª£c li√™n k·∫øt v·ªõi g·ªëc t·ª´ n√†y l√† t√™n ng·∫Øn nh·∫•t (ƒëi·ªÅu n√†y lu√¥n ch·ªçn t·ª´ s·ªë √≠t khi c√≥ c√°c bi·∫øn th·ªÉ s·ªë √≠t/s·ªë nhi·ªÅu)

```{r}
is_noun <- function(pos) {
  pos %in% c("NOUN", "VERB", "PROPN")  # "NOUN", "VERB" v√† "PROPN" l√† c√°c lo·∫°i t·ª´ danh t·ª´ trong udpipe
}

keywords_inventory <- function(dataframe, col = 'Description') {
  tokens <- unlist(tokenize_words(dataframe[[col]]))
  
  # load model x·ª≠ l√Ω ti·∫øng anh
  ud_model <- udpipe_download_model(language = "english")
  ud_model <- udpipe_load_model(ud_model$file_model)
  
  udpipe_annotated <- udpipe_annotate(ud_model, x = tokens)
  udpipe_pos <- as.data.frame(udpipe_annotated)
  
  keywords_roots  <- list()
  keywords_select <- list()
  category_keys   <- list()
  count_keywords  <- list()
  
  for (i in seq_len(nrow(udpipe_pos))) {
    word <- tolower(as.character(udpipe_pos$token[i]))
    tag <- as.character(udpipe_pos$upos[i])
    if (is_noun(tag)) {
      racine <- wordStem(word, language = "en")
      if (racine %in% names(keywords_roots)) {
        keywords_roots[[racine]] <- union(keywords_roots[[racine]], word)
        count_keywords[[racine]] <- count_keywords[[racine]] + 1
      } else {
        keywords_roots[[racine]] <- list(word)
        count_keywords[[racine]] <- 1
      }
    }
  }
  
  for (s in names(keywords_roots)) {
    if (length(keywords_roots[[s]]) > 1) {
      min_length <- 1000
      for (k in keywords_roots[[s]]) {
        if (nchar(k) < min_length) {
          clef <- k
          min_length <- nchar(k)
        }
      }
      category_keys <- c(category_keys, clef)
      keywords_select[[s]] <- clef
    } else {
      category_keys <- c(category_keys, keywords_roots[[s]][1])
      keywords_select[[s]] <- keywords_roots[[s]][1]
    }
  }
  
  cat(sprintf("Nb of keywords in variable '%s': %d\n", col, length(category_keys)))
  return(list(category_keys = category_keys, keywords_roots = keywords_roots, keywords_select = keywords_select, count_keywords = count_keywords))
}
```

```{r}
result <- keywords_inventory(df_produits)

# In th·ª≠ k·∫øt qu·∫£ t∆∞∆°ng ·ª©ng
# print(result$category_keys)
# print(result$keywords_roots)
# print(head(result$keywords_select, 10))
# print(head(result$count_keywords, 10))
```

Vi·ªác th·ª±c thi h√†m n√†y tr·∫£ v·ªÅ ba bi·∫øn quan tr·ªçng ch√≠nh:

keywords (hay category_keys): danh s√°ch c√°c t·ª´ kh√≥a ƒë∆∞·ª£c tr√≠ch xu·∫•t keywords_roots: m·ªôt list t∆∞·ª£ng trung cho t·ª´ ƒëi·ªÉn v·ªõi c√°c kh√≥a l√† c√°c t·ª´ g·ªëc c·ªßa c√°c t·ª´ kh√≥a v√† c√°c gi√° tr·ªã l√† danh s√°ch c√°c t·ª´ ƒë∆∞·ª£c li√™n k·∫øt v·ªõi nh·ªØng t·ª´ g·ªëc ƒë√≥ count_keywords: m·ªôt list t∆∞·ª£ng trung cho t·ª´ ƒëi·ªÉn li·ªát k√™ s·ªë l·∫ßn m·ªói t·ª´ ƒë∆∞·ª£c s·ª≠ d·ª•ng

Nh√≥m chuy·ªÉn ƒë·ªïi count_keywords th√†nh m·ªôt danh s√°ch, ƒë·ªÉ s·∫Øp x·∫øp c√°c t·ª´ kh√≥a theo s·ªë l·∫ßn xu·∫•t hi·ªán c·ªßa ch√∫ng:

```{r}
keywords_select <- result$keywords_select
count_keywords <- result$count_keywords

list_products <- vector("list", length = length(count_keywords))
for (i in seq_along(count_keywords)) {
  list_products[[i]] <- list(keywords_select[[names(count_keywords)[i]]], count_keywords[[i]])
}

list_products <- list_products[order(sapply(list_products, function(x) x[[2]]), decreasing = TRUE)]

# In th·ª≠ k·∫øt qu·∫£
# print(head(list_products, 5))
```

Sau ƒë√≥ v·∫Ω bi·ªÉu ƒë·ªì th·ªëng k√™ t·∫ßn su·∫•t xu·∫•t hi·ªán c·ªßa c√°c t·ª´ kho√°:

```{r}
list <- list_products[order(sapply(list_products, function(x) x[[2]]), decreasing = TRUE)]

# L·∫•y 25 ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n t·ª´ list ƒë√£ s·∫Øp x·∫øp
list <- list[1:25]

# T·∫°o plot t∆∞∆°ng t·ª± trong Python
y_axis <- sapply(list, function(x) x[[2]])
x_axis <- 1:length(list)
x_label <- unlist(sapply(list, function(x) x[[1]]))

data <- data.frame (
  x_label,
  y_axis
)

data$x_label <- reorder(data$x_label, data$y_axis)

ggplot(data, aes(x = x_label, y = y_axis)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  coord_flip() +
  labs(y = "T·∫ßn su·∫•t xu·∫•t hi·ªán", x = "", title = "T·∫ßn su·∫•t xu·∫•t hi·ªán t·ª´ (25 t·ª´ kho√° nhi·ªÅu nh·∫•t)") +
  theme_minimal()
```

## 4.3. X√°c ƒë·ªãnh danh m·ª•c s·∫£n ph·∫©m

Danh s√°ch tr√™n thu ƒë∆∞·ª£c ch·ª©a h∆°n (s·ªë n√†y ch·∫°y 500k d√≤ng m·ªõi bi·∫øt) t·ª´ kh√≥a v√† c√°c t·ª´ kh√≥a ph·ªï bi·∫øn nh·∫•t xu·∫•t hi·ªán trong h∆°n 200 s·∫£n ph·∫©m. Tuy nhi√™n, khi xem x√©t n·ªôi dung c·ªßa danh s√°ch, ta c√≥ th·ªÉ nh·∫≠n th·∫•y m·ªôt s·ªë t√™n l√† kh√¥ng c·∫ßn thi·∫øt. M·ªôt s·ªë kh√°c kh√¥ng ch·ª©a th√¥ng tin, nh∆∞ c√°c t·ª´ ch·ªâ m√†u s·∫Øc. Do ƒë√≥, nh√≥m s·∫Ω th·ª±c hi·ªán lo·∫°i b·ªè nh·ªØng t·ª´ n√†y kh·ªèi ph√¢n t√≠ch ti·∫øp theo v√† c≈©ng quy·∫øt ƒë·ªãnh ch·ªâ xem x√©t c√°c t·ª´ xu·∫•t hi·ªán h∆°n 13 l·∫ßn.

```{r}
list_products <- list()

for (i in seq_along(count_keywords)) {
  k <- names(count_keywords)[i]
  v <- count_keywords[[k]]
  
  word <- keywords_select[[k]]
  
  if (word %in% c('pink', 'blue', 'tag', 'green', 'orange')) next
  if (nchar(word) < 3 || v < 13) next
  if (grepl("\\+|/", word)) next  # S·ª≠ d·ª•ng grepl thay v√¨ str_detect
  
  list_products <- append(list_products, list(c(word, v)))
}

# S·∫Øp x·∫øp list_products theo gi·∫£m d·∫ßn c·ªßa c·ªôt th·ª© hai
list_products <- list_products[order(sapply(list_products, "[[", 2), decreasing = TRUE)]

cat('Retained keywords:', length(list_products), '\n')
```

### 4.3.1 M√£ ho√° d·ªØ li·ªáu

NOTE: s·ª≠a t√™n bi·∫øn list_prod_desc sau khi ho√†n th√†nh 100%

S·ª≠ d·ª•ng nh·ªØng t·ª´ kh√≥a n√†y ƒë·ªÉ t·∫°o c√°c nh√≥m s·∫£n ph·∫©m. ƒê·∫ßu ti√™n, x√°c ƒë·ªãnh ma tr·∫≠n ùëã nh∆∞ sau:

|           | key 1     | ... | key j     | ... | key N     |
|:---------:|-----------|-----|-----------|-----|-----------|
| product 1 | $a_{1,1}$ |     |           |     | $a_{1,N}$ |
|    ...    |           |     | ...       |     |           |
| product i | ...       |     | $a_{i,j}$ |     | ...       |
|    ...    |           |     | ...       |     |           |
| product M | $a_{M,1}$ |     |           |     | $a_{M,N}$ |

H·ªá s·ªë $a_{i,j}$ l√† 1 n·∫øu m√¥ t·∫£ c·ªßa s·∫£n ph·∫©m ${i}$ ch·ª©a t·ª´ ${j}$, v√† l√† 0 trong tr∆∞·ªùng h·ª£p ng∆∞·ª£c l·∫°i.

```{r}
list_prod_desc <- unique(df_cleaned$Description)
X <- data.frame(matrix(0, nrow = length(list_prod_desc), ncol = length(list_products)))
for (i in 1:length(list_products)) {
  key <- list_products[[i]][[1]]
  occurence <- list_products[[i]][[2]]
  v <- rep(0, length(list_prod_desc))
  for (j in 1:length(list_prod_desc))
  {
    if ( str_detect(list_prod_desc[j ], toupper(key)))
    {
      X[j,i] <- 1
    }
  }
  colnames(X)[i] <- key
}
```

Ma tr·∫≠n ùëã ch·ªâ ra c√°c t·ª´ ƒë∆∞·ª£c ch·ª©a trong m√¥ t·∫£ c·ªßa c√°c s·∫£n ph·∫©m b·∫±ng c√°ch s·ª≠ d·ª•ng nguy√™n t·∫Øc m√£ h√≥a one-hot. Trong th·ª±c t·∫ø, nh√≥m ƒë√£ ph√°t hi·ªán r·∫±ng vi·ªác ƒë∆∞a ra kho·∫£ng gi√° s·∫Ω d·∫´n ƒë·∫øn c√°c nh√≥m c√¢n ƒë·ªëi h∆°n v·ªÅ s·ªë l∆∞·ª£ng ph·∫ßn t·ª≠. Do ƒë√≥, nh√≥m s·∫Ω th√™m 6 c·ªôt b·ªï sung v√†o ma tr·∫≠n n√†y v√† ch·ªâ ra kho·∫£ng gi√° c·ªßa c√°c s·∫£n ph·∫©m:

```{r}
threshold <- c(0, 1, 2, 3, 5, 10)
label_col <- character(0)

for (i in seq_along(threshold)) {
  if (i == length(threshold)) {
    col <- paste('.>', threshold[i], sep = '')
  } else {
    col <- paste(threshold[i], '<.<', threshold[i + 1], sep = '')
  }
  label_col <- c(label_col, col)
  col_idx <- which(colnames(X) == col)
  X[, col_idx] <- 0
}

for (i in seq_along(list_prod_desc)) {
  prod <- list_prod_desc[i]
  prix <- mean(df_cleaned[df_cleaned$Description == prod, 'UnitPrice'])
  j <- 1
  while (prix > threshold[j]) {
    j <- j + 1
    if (j == length(threshold) + 1) break
  }
  X[i, label_col[j - 1]] <- 1
}
X[is.na(X)] <- 0

X
```

V√† ƒë·ªÉ ch·ªçn c√°c kho·∫£ng ph√π h·ª£p, nh√≥m s·∫Ω ki·ªÉm tra s·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong c√°c nh√≥m kh√°c nhau:

```{r}
cat(sprintf("%-8s %-20s \n", 'Range', 'Number of products'), paste(rep("-", 20), collapse = ""), "\n")

for (i in seq_along(threshold)) {
  if (i == length(threshold)) {
    col <- sprintf('.>%s', threshold[i])
  } else {
    col <- sprintf('%s<.<%s', threshold[i], threshold[i+1])
  }
  cat(sprintf("%-10s  %-20s \n", col, sum(X[,col])))
}
```

### 4.3.2. Ph√¢n c·ª•m s·∫£n ph·∫©m

Trong ph·∫ßn n√†y, nh√≥m s·∫Ω ph√¢n c·ª•m c√°c s·∫£n ph·∫©m th√†nh c√°c c·ª•m kh√°c nhau. ƒê·ªÉ x√°c ƒë·ªãnh (x·∫•p x·ªâ) s·ªë l∆∞·ª£ng c·ª•m t·ªët nh·∫•t ƒë·∫°i di·ªán cho d·ªØ li·ªáu, nh√≥m s·ª≠ d·ª•ng ƒëi·ªÉm silhouette:

```{r}
matrix <- as.matrix(X)

for (n_clusters in 3:9) {
  kmeans_result <- kmeans(matrix, centers = n_clusters, nstart = 30)
  clusters <- kmeans_result$cluster
  silhouette_vals <- silhouette(clusters, dist(matrix))
  silhouette_avg <- mean(silhouette_vals[, 3])
  cat("For n_clusters =", n_clusters, "The average silhouette_score is :", silhouette_avg, "\n")
}
```

ƒêi·ªÉm silhouette cho 5 c·ª•m cao nh·∫•t (*sau nhi·ªÅu l·∫ßn ch·∫°y, nh√≥m nh·∫≠n th·∫•y c·ª•m 5 lu√¥n cho ƒëi·ªÉm silhoutte t·ªët nh·∫•t, b√™n c·∫°nh ƒë√≥, khi th·ª±c hi·ªán v√≤ng l·∫∑p v·ªõi 5 c·ª•m, nh√≥m c≈©ng t√¨m ƒë∆∞·ª£c ƒëi·ªÉm silhoutte cao nh·∫•t cho 5 c·ª•m l√† 0.1476137*). N·∫øu ta ch·ªçn chia nhi·ªÅu c·ª•m h∆°n, th√¨ s·ªë l∆∞·ª£ng d·ªØ li·ªáu trong m·ªói c·ª•m s·∫Ω kh√° l√† √≠t, do ƒë√≥, ch·ªçn 5 c·ª•m l√† l·ª±a ch·ªçn t·ªëi ∆∞u.

Ti·∫øp ƒë·∫øn, nh√≥m s·∫Ω th·ª±c hi·ªán l·∫∑p v·ªõi 5 c·ª•m m·ª•c ƒë√≠ch ƒë·ªÉ t√¨m l·∫°i ƒëi·ªÉm silhouette trung b√¨nh c·ªßa 5 c·ª•m nh∆∞ tr√™n:

```{r}
n_clusters <- 5
silhouette_avg <- -1

while (silhouette_avg <= 0.1476137) { # thay ƒëi·ªÉm silhouette t·ªët nh·∫•t, d√πng to√°n t·ª≠ <= ƒë·ªÉ c√≥ th·ªÉ t√¨m ƒë∆∞·ª£c ƒëi·ªÉm silhouette t·ªët h∆°n
  kmeans_result <- kmeans(matrix, centers = n_clusters, nstart = 30)
  clusters <- kmeans_result$cluster
  silhouette_vals <- silhouette(clusters, dist(matrix))
  silhouette_avg <- mean(silhouette_vals[, 3])
  cat("For n_clusters =", n_clusters, "The average silhouette_score is :", silhouette_avg, "\n")
}
```

### 4.3.3. ƒê·∫∑c ƒëi·ªÉm h√≥a n·ªôi dung c·ªßa c√°c c·ª•m (clusters)

```{r}
table(clusters)
```

#### a. ƒêi·ªÉm Silhouette n·ªôi c·ª•m

```{r}
# H√†m ƒë·ªÉ ch·ªçn ng·∫´u nhi√™n n m√†u t·ª´ danh s√°ch m√†u
select_random_colors <- function(n) {
  list_of_colors <- c("red", "firebrick", "darkred", "orange", "orangered", "tomato", "yellow", "gold", "goldenrod", "lawngreen", "green", "limegreen", "darkgreen", "dodgerblue", "blue", "mediumblue", "darkslateblue", "violet", "blueviolet", "darkviolet", "purple", "darkorchid", "mediumpurple")
  all_colors <- list_of_colors[!grepl("\\d", list_of_colors)]
  if (n > length(all_colors)) {
    return (NULL)
  } else {
    random_colors <- sample(all_colors, n)  # Ch·ªçn ng·∫´u nhi√™n n m√†u
    return(random_colors)  # Tr·∫£ v·ªÅ danh s√°ch n m√†u ng·∫´u nhi√™n
  }
}

random_colors <- select_random_colors(n_clusters)

# H√†m v·∫Ω bi·ªÉu ƒë·ªì silhouette n·ªôi c·ª•m
graph_component_silhouette <- function(n_clusters, lim_x, mat_size, sample_silhouette_values, clusters) {
  
  y_lower <- 10
  data <- data.frame()
  
  for (i in 1:n_clusters) {
    ith_cluster_silhouette_values <- sample_silhouette_values[clusters == i]
    ith_cluster_silhouette_values <- sort(ith_cluster_silhouette_values)
    size_cluster_i <- length(ith_cluster_silhouette_values)
    y_upper <- y_lower + size_cluster_i - 1
    
    x_coords <- c(0, ith_cluster_silhouette_values, 0)
    y_coords <- c(y_lower, seq(y_lower, y_upper), y_upper)
    
    cluster_data <- data.frame(
      x = x_coords,
      y = y_coords,
      cluster = as.character(i)
    )
    
    data <- rbind(data, cluster_data)
    
    y_lower <- y_upper + 10
  }
  
  ggplot(data, aes(x = x, y = y, group = cluster, fill = cluster)) +
    geom_polygon(color = "black", size = 0) +
    scale_fill_manual(values = random_colors) +
    labs(x = "Silhouette coefficient values", y = "Cluster label") +
    theme_minimal()
}
```

```{r}
clusters_graph <- clusters

sample_silhouette_values <- silhouette(clusters_graph, dist(matrix))[, 3]

graph_component_silhouette(n_clusters, c(-0.07, 0.33), nrow(X), sample_silhouette_values, clusters_graph)
```

#### b. Bi·ªÉu ƒë·ªì WordCloud

```{r}
temp_list <- as.data.frame(list_prod_desc)

list_words <- unlist(lapply(list_products, function(x) x[[1]]))

occurence <- vector("list", n_clusters)

for (i in 1:n_clusters) {
  list_cluster <- temp_list[clusters_graph == i, , drop = FALSE]

  temp_dict <- list()
  for (word in list_words) {
    if (word %in% c('art', 'set', 'heart', 'pink', 'blue', 'tag')) next

    temp_dict[word] <- sum(grepl(word, tolower(as.character(list_cluster[, 1]))))
  }

  occurence[[i]] <- temp_dict
}
```

```{r}
cluster_no <- 1 # ch·ªçn cluster ƒë·ªÉ v·∫Ω (t·ª´ 1 ƒë·∫øn n_clusters)

temp <- occurence[[cluster_no]]
df <- data.frame(word = names(temp), freq = unlist(temp))
color <- as.character(random_colors[cluster_no])
wordcloud2(data=df, color = color)
```

```{r}
cluster_no <- 2 # ch·ªçn cluster ƒë·ªÉ v·∫Ω (t·ª´ 1 ƒë·∫øn n_clusters)

temp <- occurence[[cluster_no]]
df <- data.frame(word = names(temp), freq = unlist(temp))
color <- as.character(random_colors[cluster_no])
wordcloud2(data=df, color = color)
```

```{r}
cluster_no <- 3 # ch·ªçn cluster ƒë·ªÉ v·∫Ω (t·ª´ 1 ƒë·∫øn n_clusters)

temp <- occurence[[cluster_no]]
df <- data.frame(word = names(temp), freq = unlist(temp))
color <- as.character(random_colors[cluster_no])
wordcloud2(data=df, color = color)
```

```{r}
cluster_no <- 4 # ch·ªçn cluster ƒë·ªÉ v·∫Ω (t·ª´ 1 ƒë·∫øn n_clusters)

temp <- occurence[[cluster_no]]
df <- data.frame(word = names(temp), freq = unlist(temp))
color <- as.character(random_colors[cluster_no])
wordcloud2(data=df, color = color)
```

```{r}
cluster_no <- 5 # ch·ªçn cluster ƒë·ªÉ v·∫Ω (t·ª´ 1 ƒë·∫øn n_clusters)

temp <- occurence[[cluster_no]]
df <- data.frame(word = names(temp), freq = unlist(temp))
color <- as.character(random_colors[cluster_no])
wordcloud2(data=df, color = color)
```

# 5. Ph√¢n lo·∫°i kh√°ch h√†ng

## 5.1. ƒê·ªãnh d·∫°ng d·ªØ li·ªáu

Trong ph·∫ßn tr∆∞·ªõc ƒë√≥, c√°c s·∫£n ph·∫©m kh√°c nhau ƒë√£ ƒë∆∞·ª£c nh√≥m th√†nh 5 c·ª•m. ƒê·ªÉ chu·∫©n b·ªã ph·∫ßn c√≤n l·∫°i c·ªßa ph√¢n t√≠ch, b∆∞·ªõc ƒë·∫ßu ti√™n bao g·ªìm vi·ªác nh·∫≠p th√¥ng tin n√†y v√†o b·∫£ng d·ªØ li·ªáu. ƒê·ªÉ l√†m ƒëi·ªÅu n√†y, nh√≥m t·∫°o th√™m c·ªôt h·∫°ng m·ª•c categ_product trong ƒë√≥ t√¥i ch·ªâ ƒë·ªãnh c·ª•m c·ªßa m·ªói s·∫£n ph·∫©m:

```{r}
corresp <- setNames(clusters, list_prod_desc)

# Th√™m c·ªôt 'categ_product' v√†o df_cleaned
df_cleaned$categ_product <- corresp[df_cleaned$Description]

# Hi·ªÉn th·ªã d·ªØ li·ªáu sau khi th√™m c·ªôt m·ªõi
df_cleaned
```

### 5.1.1. Nh√≥m c√°c s·∫£n ph·∫©m

T·∫°o c√°c bi·∫øn categ_N (v·ªõi [categ_product) ch·ª©a s·ªë ti·ªÅn ƒë√£ chi ti√™u trong m·ªói danh m·ª•c s·∫£n ph·∫©m:

```{r}
for (i in 1:5) {
  col <- paste("categ_", i, sep = "")
  df_temp <- df_cleaned[df_cleaned$categ_product == i, ]
  price_temp <- (df_temp$UnitPrice * (df_temp$Quantity - df_temp$QuantityCanceled))
  price_temp <- ifelse(price_temp > 0, price_temp, 0)
  
  df_cleaned[[col]] <- 0
  
  # T·∫°o c·ªôt m·ªõi ch·ªâ khi c√≥ d·ªØ li·ªáu
  if (length(price_temp) > 0) {
    df_cleaned[df_cleaned$categ_product == i, col] <- price_temp
  }
}

df_cleaned
```

```{r}
basket_price <- df_cleaned %>%
  group_by(CustomerID, InvoiceNo, InvoiceDate) %>%
  summarise(
    'Basket Price' = sum(TotalPrice),
    categ_1 = sum(categ_1),
    categ_2 = sum(categ_2),
    categ_3 = sum(categ_3),
    categ_4 = sum(categ_4),
    categ_5 = sum(categ_5)
  )

basket_price
```

### 5.1.2. K·∫øt h·ª£p ƒë∆°n h√†ng c·ªßa ng∆∞·ªùi ti√™u d√πng

Nh√≥m c√°c m·ª•c kh√°c nhau m√† t∆∞∆°ng ·ª©ng v·ªõi c√πng m·ªôt ng∆∞·ªùi d√πng. NhoÃÅm x√°c ƒë·ªãnh s·ªë l·∫ßn mua h√†ng c·ªßa ng∆∞·ªùi d√πng, c≈©ng nh∆∞ c√°c s·ªë l∆∞·ª£ng t·ªëi thi·ªÉu, t·ªëi ƒëa, trung b√¨nh v√† t·ªïng s·ªë ti·ªÅn ƒë√£ chi tr·∫£ trong t·∫•t c·∫£ c√°c l·∫ßn mua h√†ng:

```{r}
last_date <- as.POSIXct(max(basket_price$InvoiceDate), format = "%m/%d/%Y %H:%M")
last_date

transactions_per_user <- basket_price %>%
  group_by(CustomerID) %>%
  summarise(
    count = n(),
    min = min(`Basket Price`),
    max = max(`Basket Price`),
    mean = mean(`Basket Price`),
    sum = sum(`Basket Price`),
    categ_1 = (sum(categ_1) / sum) * 100,
    categ_2 = (sum(categ_2) / sum) * 100,
    categ_3 = (sum(categ_3) / sum) * 100,
    categ_4 = (sum(categ_4) / sum) * 100,
    categ_5 = (sum(categ_5) / sum) * 100
  )

transactions_per_user
```

Cu·ªëi c√πng, nhoÃÅm ƒë·ªãnh nghƒ©a hai bi·∫øn b·ªï sung l√†m cho ch√∫ng cho bi·∫øt s·ªë ng√†y tr√¥i qua k·ªÉ t·ª´ l·∫ßn mua ƒë·∫ßu ti√™n (FirstPurchase) v√† s·ªë ng√†y k·ªÉ t·ª´ l·∫ßn mua cu·ªëi c√πng (LastPurchase):

```{r}
last_date <- as.POSIXct(max(basket_price$InvoiceDate), format = "%m/%d/%Y %H:%M")
last_date

first_registration <- basket_price %>%
  group_by(CustomerID) %>%
  summarise(FirstPurchase = min(InvoiceDate)) %>%
  ungroup() %>%
  mutate(FirstPurchase = as.integer(round(difftime(last_date, FirstPurchase, units = "days"))))

last_purchase <- basket_price %>%
  group_by(CustomerID) %>%
  summarise(LastPurchase = max(InvoiceDate)) %>%
  ungroup() %>%
  mutate(LastPurchase = as.integer(round(difftime(last_date, LastPurchase, units = "days"))))

transactions_per_user[["LastPurchase"]] <- last_purchase$LastPurchase
transactions_per_user[["FirstPurchase"]] <- first_registration$FirstPurchase

transactions_per_user <- na.omit(transactions_per_user)

transactions_per_user
```

M·ªôt danh m·ª•c kh√°ch h√†ng ƒë·∫∑c bi·ªát quan tr·ªçng l√† nh·ªØng kh√°ch h√†ng ch·ªâ th·ª±c hi·ªán m·ªôt l·∫ßn mua. Trong ph·∫ßn n√†y, nhoÃÅm nh·∫≠n th·∫•y r·∫±ng lo·∫°i kh√°ch h√†ng n√†y chi·∫øm 1/3 s·ªë l∆∞·ª£ng kh√°ch h√†ng ƒë∆∞·ª£c li·ªát k√™:

```{r}
# T√≠nh s·ªë l∆∞·ª£ng kh√°ch h√†ng c√≥ giao d·ªãch duy nh·∫•t v√† ph·∫ßn trƒÉm t∆∞∆°ng ·ª©ng
n1 <- sum(transactions_per_user$count == 1)
n2 <- nrow(transactions_per_user)
percentage <- n1 / n2 * 100

# Hi·ªÉn th·ªã k·∫øt qu·∫£
cat(sprintf("S·ªë l∆∞·ª£ng kh√°ch h√†ng v·ªõi giao d·ªãch duy nh·∫•t: %d/%d (%.2f%%)\n", n1, n2, percentage))
```

## 5.2. T·∫°o danh m·ª•c kh√°ch h√†ng

### 5.2.1. M√£ ho√° - ƒë·ªãnh d·∫°ng d·ªØ li·ªáu

```{r}
list_cols <- c('count', 'min', 'max', 'mean', 'categ_1', 'categ_2', 'categ_3', 'categ_4', 'categ_5')

# T·∫°o m·ªôt b·∫£n sao c·ªßa transactions_per_user
selected_customers <- transactions_per_user

# Chuy·ªÉn ƒë·ªïi th√†nh ma tr·∫≠n
matrix <- as.matrix(selected_customers[, list_cols])
```

```{r}
# T√≠nh mean v√† standard deviation c·ªßa t·ª´ng c·ªôt
means <- colMeans(matrix)
std_devs <- apply(matrix, 2, sd)

# Chu·∫©n h√≥a d·ªØ li·ªáu theo z-score
scaled_matrix <- scale(matrix, center = means, scale = std_devs)

# In ra gi√° tr·ªã mean c·ªßa t·ª´ng bi·∫øn
cat("variables mean values: \n",  "\n", means, "\n")

# In ra ma tr·∫≠n sau khi ƒë∆∞·ª£c chu·∫©n h√≥a
# scaled_matrix
```

### 5.2.2. T·∫°o danh m·ª•c kh√°ch h√†ng

NhoÃÅm ƒë·ªãnh nghƒ©a c√°c c·ª•m kh√°ch h√†ng t·ª´ ma tr·∫≠n ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a tr∆∞·ªõc ƒë√≥ v√† s·ª≠ d·ª•ng thu·∫≠t to√°n k-means. Ch·ªçn s·ªë c·ª•m d·ª±a tr√™n ƒëi·ªÉm silhouette v√† t√¨m th·∫•y r·∫±ng ƒëi·ªÉm s·ªë t·ªët nh·∫•t ƒë∆∞·ª£c ƒë·∫°t ƒë∆∞·ª£c v·ªõi 11 c·ª•m:

```{r warning=FALSE}
n_clusters <- 11
silhouette_avg <- -1

while (silhouette_avg <= 0.218421) {
  kmeans_result <- kmeans(scaled_matrix, centers = n_clusters, nstart = 30)
  clusters_clients <- kmeans_result$cluster
  silhouette_vals <- silhouette(clusters_clients, dist(scaled_matrix))
  silhouette_avg <- mean(silhouette_vals[, 3])
  cat(sprintf("Silhouette score: %f\n", silhouette_avg))
}
```

Tr∆∞·ªõc ti√™n, nhoÃÅm xem s·ªë l∆∞·ª£ng kh√°ch h√†ng trong m·ªói c·ª•m:

```{r}
table(clusters_clients)
```

```{r}
nrow(scaled_matrix)
```

#### a. ƒêi·ªÉm Silhoutte n·ªôi c·ª•m

T∆∞∆°ng t·ª± nh∆∞ v·ªõi c√°c danh m·ª•c s·∫£n ph·∫©m, m·ªôt c√°ch kh√°c ƒë·ªÉ ƒë√°nh gi√° ch·∫•t l∆∞·ª£ng c·ªßa s·ª± ph√¢n t√°ch l√† xem c√°c ƒëi·ªÉm silhouette trong c√°c c·ª•m kh√°c nhau:

```{r}
clusters_graph <- clusters_clients

random_colors <- select_random_colors(n_clusters)

sample_silhouette_values <- silhouette(clusters_graph, dist(scaled_matrix))[, 3]

graph_component_silhouette(n_clusters, c(-0.15, 0.55), nrow(scaled_matrix), sample_silhouette_values, clusters_graph)
```

#### b. H√¨nh th√°i kh√°ch h√†ng

```{r}
# G√°n c·ªôt 'cluster' t·ª´ clusters_clients v√†o selected_customers
selected_customers$cluster <- clusters_clients
selected_customers
```

```{r}
test_df <- list()

for (i in 1:n_clusters) {
  test <- selected_customers[selected_customers$cluster == i,]
  size <- nrow(test)
  test <- subset(test, select = -c(CustomerID))
  test <- as.list(colMeans(test))
  test$size <- size
  test_df[[i]] <- test
}

merged_df <- do.call(rbind, lapply(test_df, as.data.frame))
merged_df
```

T·ªïng quan v·ªÅ n·ªôi dung c·ªßa m·ªói c·ª•m:

```{r}
for (i in 1:n_clusters) {
  df_percent <- subset(merged_df, select = -c(min, max, LastPurchase, FirstPurchase, size, cluster)) %>%
    mutate_all(function(x) (x / sum(x)) * 100)
  
  df_radar <- rbind(rep(100, length(df_percent)), rep(0, length(df_percent)), df_percent[i, ])
  
  radarchart(
    df_radar,
    axistype = 1,
    
    #custom polygon
    pcol = random_colors[i],
    # pfcol = random_colors[i],
    plwd = 0.8,
    
    title = paste("Cluster n¬∫", i),
    
    #custom the grid
    cglcol = "grey",
    cglty = 1,
    axislabcol = "grey",
    caxislabels = seq(0, 100, 25),
    cglwd = 0.8,
    
    #custom labels
    vlcex = 1
  )
}
```

## 5.3. Ph√¢n t√≠ch h√†nh vi mua h√†ng

Ph·∫ßn 5.3 n√†y s·∫Ω ph√¢n t√≠ch v·ªÅ:

TotalSales: T·ªïng gi√° tr·ªã t·∫•t c·∫£ ƒë∆°n h√†ng m√† kh√°ch h√†ng ƒë√£ mua.

OrderCount: S·ªë l∆∞·ª£ng ƒë∆°n h√†ng m√† kh√°ch h√†ng ƒë√£ ƒë·∫∑t.

AvgOrderVal: Gi√° tr·ªã trung b√¨nh m·ªói ƒë∆°n h√†ng c·ªßa kh√°ch h√†ng.

```{r}
df_customer <- df_cleaned_f %>%
  group_by(CustomerID) %>%
  summarize(TotalSales = sum(TotalPrice),
            OrderCount = length(unique(InvoiceDate))) %>%
  mutate(AvgOrderVal = TotalSales / OrderCount)
df_customer
```

```{r}
df_rank_cus <- df_customer %>%
  mutate(
    TotalSales = rank(TotalSales),
    OrderCount = rank(OrderCount,
                      ties.method = "first"),
    AvgOrderVal = rank(AvgOrderVal)
  )

# Chu·∫©n ho√° d·ªØ li·ªáu
df_scale_cus <- df_rank_cus %>%
  mutate(
    TotalSales = scale(TotalSales),
    OrderCount = scale(OrderCount),
    AvgOrderVal = scale(AvgOrderVal)
  )

#look at the summary of the normalized data
summary(df_scale_cus)
sapply(df_scale_cus, sd)
```

Gi√° tr·ªã ƒë∆∞·ª£c t·∫≠p trung sau khi chu·∫©n ho√° c√≥ ƒë·ªô l·ªách chu·∫©n l√† 1. B√¢y gi·ªù, ƒëem d·ªØ li·ªáu n√†y ƒë·ªÉ ph√¢n t√≠ch ph√¢n c·ª•m (d√πng k-means):

```{r}
for(n_clusters in 3:9) {
  cluster <- kmeans(df_scale_cus[c("TotalSales", "OrderCount", "AvgOrderVal")], n_clusters)
  silhouette_avg <- mean(silhouette(cluster$cluster,
                                     dist(df_scale_cus[c("TotalSales", "OrderCount", "AvgOrderVal")],
                                          method = "euclidean"))[, 3])
  cat("For n_clusters =", n_clusters, "The average silhouette_score is :", silhouette_avg, "\n")
}
```

```{r}
n_clusters <- 4
silhouette_avg <- -1

# 4: 0.4142249
# 3: 0.4156512

while (silhouette_avg <= 0.4142249) { # ch·ªó n√†y thay ƒëi·ªÉm silhouette t·ªët nh·∫•t, d√πng to√°n t·ª≠ <= ƒë·ªÉ c√≥ th·ªÉ t√¨m ƒë∆∞·ª£c ƒëi·ªÉm silhouette t·ªët h∆°n
  cluster <- kmeans(df_scale_cus[c("TotalSales", "OrderCount", "AvgOrderVal")], n_clusters)
  silhouette_avg <- mean(silhouette(cluster$cluster,
                                     dist(df_scale_cus[c("TotalSales", "OrderCount", "AvgOrderVal")],
                                          method = "euclidean"))[, 3])
  cat("For n_clusters =", n_clusters, "The average silhouette_score is :", silhouette_avg, "\n")
}
```

```{r}
df_scale_cus$Cluster <- cluster$cluster

ggplot(df_scale_cus, aes(x = AvgOrderVal, y = OrderCount, color = Cluster)) +
  geom_point() +
  theme_minimal()
```

# 6. Ph√¢n t√≠ch v√† d·ª± ƒëo√°n doanh thu

```{r}
# D√πng dataframe df_cleaned_f ƒë√£ copy t·ª´ chunk 24
df_cleaned_f$Country <- as.factor(df_cleaned_f$Country)
df_cleaned_f$date <- as.Date(df_cleaned_f$InvoiceDate)
df_cleaned_f$day <- as.factor(day(df_cleaned_f$InvoiceDate))
df_cleaned_f$month <- as.factor(month(df_cleaned_f$InvoiceDate))
df_cleaned_f$year <- as.factor(year(df_cleaned_f$InvoiceDate))
levels(df_cleaned_f$year) <- c(2010, 2011)
df_cleaned_f$hourOfDay <- as.factor(hour(df_cleaned_f$InvoiceDate))
df_cleaned_f$dayOfWeek <- as.factor(wday(df_cleaned_f$InvoiceDate, label = TRUE))

df_cleaned_f
```

## 6.1. Ph√¢n t√≠ch doanh thu

### 6.1.1. Doanh thu h·∫±ng th√°ng

```{r}
monthly_sale <- df_cleaned_f %>% 
  group_by(month, year) %>%
  summarise(TotalPrice = sum(TotalPrice), .groups = 'drop') %>%
  arrange(desc(TotalPrice)) %>%
  ungroup()

ggplot(data = monthly_sale, aes(
  x = reorder(as.factor(month), TotalPrice),
  y = TotalPrice,
  fill = month
)) +
  geom_bar(stat = "identity") +
  labs(y = "Doanh thu (¬£)", x = "Th√°ng",
       title = "Doanh thu h·∫±ng th√°ng") +
  coord_flip() +
  theme_minimal()
```

### 6.1.2. Doanh s·ªë b√°n h√†ng di·ªÖn ra v√†o ng√†y trong tu·∫ßn

```{r}
week_sale <- df_cleaned_f %>% 
  group_by(dayOfWeek) %>%
  summarise(TotalPrice = sum(TotalPrice), .groups = 'drop') %>%
  arrange(desc(TotalPrice)) %>%
  ungroup()

ggplot(data = week_sale, aes(
  x = reorder(as.factor(dayOfWeek), TotalPrice),
  y = TotalPrice,
  fill = dayOfWeek
)) +
  geom_bar(stat = "identity") +
  labs(x = "Ng√†y trong tu·∫ßn", y = "Doanh thu (¬£)",
       title = "Doanh s·ªë b√°n h√†ng di·ªÖn ra v√†o ng√†y trong tu·∫ßn") +
  coord_flip() +
  theme_minimal()
```

### 6.1.3. Doanh s·ªë b√°n h√†ng di·ªÖn ra v√†o th·ªùi ƒëi·ªÉm trong ng√†y

```{r}
hour_sale <- df_cleaned_f %>% 
  group_by(hourOfDay) %>%
  summarise(TotalPrice = sum(TotalPrice), .groups = 'drop') %>%
  arrange(desc(TotalPrice)) %>%
  ungroup()

ggplot(data = hour_sale, aes(
  x = reorder(as.factor(hourOfDay), TotalPrice),
  y = TotalPrice,
  fill = hourOfDay
)) +
  geom_bar(stat = "identity") +
  labs(x = "Gi·ªù", y = "Doanh thu (¬£)",
       title = "Doanh s·ªë b√°n h√†ng di·ªÖn ra v√†o th·ªùi ƒëi·ªÉm trong ng√†y") +
  coord_flip() +
  theme_minimal()
```

### 6.1.4. T·ªïng doanh thu theo ng√†y trong th√°ng

```{r}
monthday_sale <- df_cleaned_f %>% 
  group_by(month, day) %>%
  summarise(TotalPrice = sum(TotalPrice), .groups = 'drop') %>%
  arrange(month, day) %>%
  ungroup()

ggplot(monthday_sale, aes(fill = month, y = TotalPrice, x = day)) +
  labs(x = "Ng√†y", y = "Doanh thu (¬£)",
       title = "Doanh s·ªë b√°n h√†ng di·ªÖn ra v√†o th·ªùi ƒëi·ªÉm trong ng√†y") +
  geom_bar(position = "stack", stat = "identity") +
  coord_flip() +
  theme_minimal()
```

## 6.2. Ph√¢n t√≠ch v√† d·ª± ƒëo√°n doanh thu

```{r}
sale_data <- df_cleaned_f %>%
  group_by(date) %>%
  summarise(revenue = sum(TotalPrice), .groups = 'drop')

ggplot(sale_data, aes(x = date, y = revenue)) + 
  geom_line() + 
  geom_smooth(method = 'auto', se = FALSE) + 
  labs(x = 'Ng√†y', y = 'Doanh thu (¬£)', title = 'Doanh thu theo ng√†y') +
  theme_minimal()
```

```{r}
sale_data <- sale_data %>% rename(ds = date, y = revenue)
sale_data
```

```{r}
weekend <- data.frame(
  holiday = 'weekend',
  ds = as.Date(c('2010-12-04', '2010-12-11', '2010-12-18',
                 '2011-01-08', '2011-01-15', '2011-01-22',
                 '2011-01-29', '2011-02-05', '2011-02-12',
                 '2011-02-19', '2011-02-26', '2011-03-05',
                 '2011-03-12', '2011-03-12', '2011-03-19',
                 '2011-03-26', '2011-04-02', '2011-04-09',
                 '2011-04-16', '2011-04-23', '2011-04-30',
                 '2011-05-07', '2011-05-14', '2011-05-21',
                 '2011-05-28', '2011-06-04', '2011-06-11',
                 '2011-04-30', '2011-06-18', '2011-06-25',
                 '2011-07-02', '2011-07-09', '2011-07-16',
                 '2011-07-23', '2011-07-30', '2011-08-06',
                 '2011-08-13', '2011-08-20', '2011-08-27',
                 '2011-09-03', '2011-09-10', '2011-09-17',
                 '2011-09-24', '2011-10-01', '2011-10-08',
                 '2011-10-15', '2011-10-22', '2011-10-29',
                 '2011-11-05', '2011-11-12', '2011-11-19',
                 '2011-11-26', '2011-12-03')),
  lower_window = 0,
  upper_window = 1
)
festival <- data.frame(
  holiday = 'festival',
  ds = as.Date(c('2010-12-24', '2010-12-25', '2010-12-26',
                 '2010-12-27', '2010-12-28', '2010-12-29',
                 '2010-12-30', '2010-12-31', '2011-01-01',
                 '2011-01-02', '2011-01-03', '2011-04-22',
                 '2011-04-24', '2011-04-25', '2011-04-29',
                 '2011-05-02', '2011-05-30', '2011-08-29')),
  lower_window = 0,
  upper_window = 1
)
holidays <- bind_rows(weekend, festival)
holidays
```

```{r}
model <- prophet(sale_data, holidays = holidays, yearly.seasonality=FALSE, daily.seasonality=FALSE)
future <- make_future_dataframe(model, periods = 80)
tail(future)
# model <- add_country_holidays(model, country_name = 'UK')
# model <- fit.prophet(model, sale_data)

model$train.holiday.names
forecast <- predict(model, future)
prophet_plot_components(model, forecast)
plot(model, forecast)
```

# 7. S·ª≠ d·ª•ng c√°c model ƒë·ªÉ ph√¢n lo·∫°i kh√°ch h√†ng

Trong ph·∫ßn n√†y, m·ª•c ti√™u s·∫Ω l√† ƒëi·ªÅu ch·ªânh m·ªôt b·ªô ph√¢n lo·∫°i s·∫Ω ph√¢n lo·∫°i ng∆∞·ªùi ti√™u d√πng v√†o c√°c lo·∫°i kh√°ch h√†ng kh√°c nhau ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p ·ªü ph·∫ßn tr∆∞·ªõc. M·ª•c ti√™u l√† l√†m cho ph√¢n lo·∫°i n√†y c√≥ th·ªÉ th·ª±c hi·ªán ƒë∆∞·ª£c ngay t·ª´ l·∫ßn truy c·∫≠p ƒë·∫ßu ti√™n.

V√¨ m·ª•c ti√™u l√† x√°c ƒë·ªãnh l·ªõp m√† m·ªôt kh√°ch h√†ng thu·ªôc v·ªÅ v√† ƒëi·ªÅu n√†y, ngay t·ª´ l·∫ßn truy c·∫≠p ƒë·∫ßu ti√™n, nh√≥m ch·ªâ gi·ªØ l·∫°i c√°c bi·∫øn m√¥ t·∫£ n·ªôi dung c·ªßa gi·ªè h√†ng v√† kh√¥ng xem x√©t c√°c bi·∫øn li√™n quan ƒë·∫øn t·∫ßn su·∫•t truy c·∫≠p ho·∫∑c bi·∫øn thi√™n c·ªßa gi√° gi·ªè h√†ng theo th·ªùi gian:

```{r}
X <- subset(selected_customers, select = c(mean, categ_1, categ_2, categ_3, categ_4, categ_5))
# X
Y <- c(selected_customers$cluster)
# Y
```

Cu·ªëi c√πng, nhoÃÅm chia b·ªô d·ªØ li·ªáu th√†nh t·∫≠p train v√† t·∫≠p test:

```{r}
# X l√† d·ªØ li·ªáu ƒë·∫∑c tr∆∞ng, Y l√† nh√£n ho·∫∑c bi·∫øn ph·∫£n h·ªìi
# train_size = 0.8 ch·ªâ ƒë·ªãnh t·ª∑ l·ªá cho t·∫≠p hu·∫•n luy·ªán (80%)

# Chia d·ªØ li·ªáu th√†nh t·∫≠p hu·∫•n luy·ªán (80%) v√† t·∫≠p ki·ªÉm tra (20%)
split <- createDataPartition(Y, times = 1, p = 0.8, list = FALSE)

X_train <- X[split,]
# X_train
X_test <- X[-split,]
# X_test
Y_train <- Y[split]
# Y_train
Y_test <- Y[-split]
# Y_test
```

## 7.1. Support Vector Machine

```{r}
# Combine X_train and Y_train into one dataframe
train_data <- cbind(X_train, Y_train)

# Set up the parameters
tuneGrid <- expand.grid(C = 10 ^ seq(-2, 2, length.out = 10))

# Train the SVM model with linear kernel using cross-validation
svm_model <-
  train(
    factor(Y_train) ~ .,
    data = train_data,
    method = "svmLinear",
    trControl = trainControl(method = "cv", number = 5),
    tuneGrid = tuneGrid
  )

# Predict on the test data
test_data <- cbind(X_test, Y_test)
predictions <- predict(svm_model, newdata = test_data)
# Confusion matrix

conf_matrix <- confusionMatrix(predictions, factor(Y_test))
conf_matrix$table
# Calculate accuracy
accuracy_svm <- mean(predictions == Y_test) * 100
cat("Accuracy:", accuracy_svm, "%\n\n")

plot(svm_model)
```

## 7.2. k-Nearest Neighbors

```{r}
knn_model <-
  train(as.factor(Y_train) ~ .,
        data = cbind(X_train, Y_train),
        method = "knn")

# D·ª± ƒëo√°n tr√™n t·∫≠p ki·ªÉm th·ª≠
predictions <- predict(knn_model, newdata = X_test)

# ƒê√°nh gi√° m√¥ h√¨nh
conf_matrix_knn <- table(predictions, Y_test)
accuracy_knn <- sum(diag(conf_matrix_knn)) / sum(conf_matrix_knn)
print(conf_matrix_knn)
cat("Accuracy:", accuracy_knn * 100, "%\n\n")
plot(knn_model)
```

## 7.3. Decision Tree

```{r}
dt_model <-
  rpart(Y_train ~ .,
        data = cbind(X_train, Y_train),
        method = "class")

print(dt_model)

# V·∫Ω c√¢y quy·∫øt ƒë·ªãnh (Decision Tree)
plot(dt_model)
text(dt_model, pretty = 0)

# D·ª± ƒëo√°n tr√™n t·∫≠p hu·∫•n luy·ªán
predictions <- predict(dt_model, X_test, type = "class")

# ƒê√°nh gi√° hi·ªáu su·∫•t
confusion_matrix <- table(predictions, Y_test)
print(confusion_matrix)

# T√≠nh accuracy
accuracy_dt <- sum(diag(confusion_matrix)) / sum(confusion_matrix)
cat("Accuracy:", accuracy_dt * 100, "%\n\n")
```

## 7.4. Random Forest

```{r}
# X√¢y d·ª±ng m√¥ h√¨nh Random Forest
model_rf <- randomForest(X_train, as.factor(Y_train) , ntree = 300)

# In th√¥ng tin v·ªÅ m√¥ h√¨nh
print(model_rf)

# D·ª± ƒëo√°n tr√™n t·∫≠p ki·ªÉm tra
predictions_rf <- predict(model_rf, newdata = X_test)

# ƒê√°nh gi√° hi·ªáu su·∫•t
confusion_matrix_rf <- table(predictions_rf, Y_test)
print(confusion_matrix_rf)

# T√≠nh accuracy
accuracy_rf <- sum(diag(confusion_matrix_rf)) / sum(confusion_matrix_rf)
cat("Accuracy:", accuracy_rf * 100, "%\n\n")
```

# 8. K·∫øt lu·∫≠n

B√†i b√°o c√°o d·ª±a tr√™n m·ªôt c∆° s·ªü d·ªØ li·ªáu cung c·∫•p th√¥ng tin v·ªÅ c√°c giao d·ªãch mua s·∫Øm tr√™n m·ªôt n·ªÅn t·∫£ng th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠ trong m·ªôt kho·∫£ng th·ªùi gian m·ªôt nƒÉm. M·ªói m·ª•c trong b·ªô d·ªØ li·ªáu m√¥ t·∫£ vi·ªác mua s·∫Øm m·ªôt s·∫£n ph·∫©m b·ªüi m·ªôt kh√°ch h√†ng c·ª• th·ªÉ v√† v√†o m·ªôt ng√†y nh·∫•t ƒë·ªãnh. T·ªïng c·ªông, c√≥ kho·∫£ng 4000 kh√°ch h√†ng xu·∫•t hi·ªán trong c∆° s·ªü d·ªØ li·ªáu. D·ª±a tr√™n th√¥ng tin c√≥ s·∫µn, nh√≥m em quy·∫øt ƒë·ªãnh ph√°t tri·ªÉn m·ªôt b·ªô ph√¢n lo·∫°i cho ph√©p d·ª± ƒëo√°n lo·∫°i mua s·∫Øm m√† m·ªôt kh√°ch h√†ng s·∫Ω th·ª±c hi·ªán, c≈©ng nh∆∞ s·ªë l·∫ßn gh√© thƒÉm m√† kh√°ch h√†ng n√†y s·∫Ω th·ª±c hi·ªán trong m·ªôt nƒÉm. Giai ƒëo·∫°n ƒë·∫ßu ti√™n c·ªßa c√¥ng vi·ªác n√†y bao g·ªìm vi·ªác m√¥ t·∫£ c√°c s·∫£n ph·∫©m kh√°c nhau ƒë∆∞·ª£c b√°n b·ªüi trang web, nh√≥m c√°c s·∫£n ph·∫©m kh√°c nhau th√†nh 5 danh m·ª•c ch√≠nh. Trong b∆∞·ªõc ti·∫øp theo, nh√≥m th·ª±c hi·ªán m·ªôt ph√¢n lo·∫°i v·ªÅ kh√°ch h√†ng b·∫±ng c√°ch ph√¢n t√≠ch th√≥i quen ti√™u d√πng c·ªßa h·ªç. Nh√≥m em ƒë√£ ph√¢n lo·∫°i kh√°ch h√†ng th√†nh 11 danh m·ª•c ch√≠nh d·ª±a tr√™n lo·∫°i s·∫£n ph·∫©m h·ªç th∆∞·ªùng mua, s·ªë l·∫ßn gh√© thƒÉm h·ªç th·ª±c hi·ªán v√† s·ªë ti·ªÅn h·ªç chi ti√™u. M·ªôt khi c√°c danh m·ª•c n√†y ƒë∆∞·ª£c x√°c ƒë·ªãnh, nh√≥m s·∫Ω ti·∫øp t·ª•c ph√¢n lo·∫°i ng∆∞·ªùi ti√™u d√πng b·∫±ng c√°c m√¥ h√¨nh h·ªçc m√°y nh∆∞ l√† Support Vector Machine Classifier (SVM), k-Nearest Neighbors, Decision Tree, Random Forest. Sau ƒë√≥ s·∫Ω xem x√©t m√¥ h√¨nh n√†o c√≥ k·∫øt qu·∫£ t·ªët nh·∫•t. Ngo√†i ra c√≤n c√≥ v·∫Ω c√°c lo·∫°i bi·ªÉu ƒë·ªì ƒë·ªÉ m√¥ t·∫£ c√°c th√¥ng tin quan tr·ªçng c·ªßa b·ªô d·ªØ li·ªáu nh∆∞ l√† doanh thu theo ng√†y, th√°ng, nƒÉm v√† nhi·ªÅu th√¥ng tin quan tr·ªçng kh√°c.

# 9. Tham kh·∫£o

1.  CARRIE (2017). E-Commerce Data Actual transactions from UK retailer. Kaggle: C·ªông ƒë·ªìng khoa h·ªçc d·ªØ li·ªáu v√† h·ªçc m√°y c·ªßa b·∫°n. Truy c·∫≠p ng√†y 15 th√°ng 12 nƒÉm 2023: <https://www.kaggle.com/datasets/carrie1/ecommerce-data>

2.  Abld All Awan (Th√°ng 6 nƒÉm 2023). K-Nearest Neighbors (KNN) Classification with R Tutorial. DataCamp. Truy c·∫≠p ng√†y 15 th√°ng 12 nƒÉm 2023: <https://www.datacamp.com/tutorial/k-nearest-neighbors-knn-classification-with-r-tutorial>

3.  Eugenia Anello (Th√°ng 3 nƒÉm 2023). K-Means Clustering in R Tutorial. DataCamp. Truy c·∫≠p ng√†y 15 th√°ng 12 nƒÉm 2023: <https://www.datacamp.com/tutorial/k-means-clustering-r>

4.  Yan Holtz. The R Graph Gallery. Truy c·∫≠p ng√†y 10 th√°ng 12 nƒÉm 2023: <https://r-graph-gallery.com/index.html>

5.  Arunn Thevapalan (Th√°ng 6 nƒÉm 2023). Decision Trees in Machine Learning Using R. Truy c·∫≠p ng√†y 17 th√°ng 12 nƒÉm 2023: <https://www.datacamp.com/tutorial/decision-trees-R>

6.  DUÃ£C ƒêOAÃÄN TRIÃÄNH (Th√°ng 1 nƒÉm 2022). Random Forest trong R, h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng trong R. Websitehcm. Truy c·∫≠p ng√†y 17 th√°ng 12 nƒÉm 2023: <https://websitehcm.com/random-forest-trong-r-huong-dan-su-dung-trong-r/>

# 10. ƒê√°nh gi√° th√†nh vi√™n

ƒê√°nh gi√° th√†nh vi√™n

| Th√†nh vi√™n                      | ƒê√≥ng g√≥p                                                                                                                                                                                                                                                                                                                   | M·ª©c ƒë·ªô ho√†n th√†nh | ∆Øu ƒëi·ªÉm                                                                                                     | Nh∆∞·ª£c ƒëi·ªÉm                                                                                                  |
|---------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------|-------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------|
| TƒÉng Hu·ª≥nh Minh Ti·∫øn - 21133088 | T√¨m ki·∫øm t·∫≠p d·ªØ li·ªáu, ph√¢n lo·∫°i kh√°ch h√†ng (ph√¢n t√≠ch h√†nh vi mua h√†ng), ph√¢n t√≠ch v√† d·ª± ƒëo√°n doanh thu (ph√¢n t√≠ch doanh thu h·∫±ng th√°ng, doanh s·ªë b√°n h√†ng di·ªÖn ra v√†o c√°c ng√†y trong tu·∫ßn, c√°c th·ªùi ƒëi·ªÉm trong ng√†y, t·ªïng doanh thu theo ng√†y trong th√°ng). S·ª≠ d·ª•ng model Support Vector Machine ƒë·ªÉ ph√¢n lo·∫°i kh√°ch h√†ng. | 100%              | T√≠ch c·ª±c ho√†n th√†nh ƒë√∫ng th·ªùi gian v√† c√°c nhi·ªám v·ª• ƒë∆∞·ª£c giao, c√≥ nhi·ªÅu √Ω ki·∫øn ƒë√≥ng g√≥p cho ƒë·ªÅ t√†i c·ªßa nh√≥m. | Do th·ªùi gian h·∫°n ch·∫ø n√™n c√≤n m·ªôt s·ªë sai s√≥t nh·∫•t ƒë·ªãnh, Thi·∫øu th·ªùi gian ƒë·ªÉ nghi√™n c·ª©u v√† t√¨m hi·ªÉu v·ªÅ ƒë·ªÅ t√†i. |
| Nguy·ªÖn Ho√†n Th·∫£o - 21133081     | T√¨m ki·∫øm t·∫≠p d·ªØ li·ªáu, khai ph√° d·ªØ li·ªáu, ph√¢n t√≠ch th√¥ng tin chi ti·∫øt v·ªÅ c√°c danh m·ª•c s·∫£n ph·∫©m (Nh·ªØng s·∫£n ph·∫©m ƒë∆∞·ª£c mua nhi·ªÅu nh·∫•t), Ph√¢n lo·∫°i kh√°ch h√†ng, ƒê·ªãnh d·∫°ng d·ªØ li·ªáu, Nh√≥m c√°c s·∫£n ph·∫©m, K·∫øt h·ª£p ƒë∆°n h√†ng c·ªßa ng∆∞·ªùi ti√™u d√πng). S·ª≠ d·ª•ng model k-Nearest Neighbors ƒë·ªÉ ph√¢n lo·∫°i kh√°ch h√†ng.                          | 100%              | T√≠ch c·ª±c ho√†n th√†nh ƒë√∫ng th·ªùi gian v√† c√°c nhi·ªám v·ª• ƒë∆∞·ª£c giao, c√≥ nhi·ªÅu √Ω ki·∫øn ƒë√≥ng g√≥p cho ƒë·ªÅ t√†i c·ªßa nh√≥m. | Do th·ªùi gian h·∫°n ch·∫ø n√™n c√≤n m·ªôt s·ªë sai s√≥t nh·∫•t ƒë·ªãnh, Thi·∫øu th·ªùi gian ƒë·ªÉ nghi√™n c·ª©u v√† t√¨m hi·ªÉu v·ªÅ ƒë·ªÅ t√†i. |
| Nguy·ªÖn Th√†nh Trung - 21133090   | T√¨m ki·∫øm t·∫≠p d·ªØ li·ªáu, khai pha d·ªØ li·ªáu, ph√¢n t√≠ch th√¥ng tin chi ti·∫øt v·ªÅ c√°c danh m·ª•c s·∫£n ph·∫©m (M√¥ t·∫£ s·∫£n ph·∫©m - Description), Ph√¢n lo·∫°i kh√°ch h√†ng (T·∫°o danh m·ª•c kh√°ch h√†ng, M√£ h√≥a- ƒë·ªãnh d·∫°ng d·ªØ li·ªáu, ƒêi·ªÉm Silhoutte n·ªôi c·ª•m, H√¨nh th√°i kh√°ch h√†ng), S·ª≠ d·ª•ng model Decision Tree ƒë·ªÉ ph√¢n lo·∫°i kh√°ch h√†ng.                | 100%              | T√≠ch c·ª±c ho√†n th√†nh ƒë√∫ng th·ªùi gian v√† c√°c nhi·ªám v·ª• ƒë∆∞·ª£c giao, c√≥ nhi·ªÅu √Ω ki·∫øn ƒë√≥ng g√≥p cho ƒë·ªÅ t√†i c·ªßa nh√≥m. | Do th·ªùi gian h·∫°n ch·∫ø n√™n c√≤n m·ªôt s·ªë sai s√≥t nh·∫•t ƒë·ªãnh, Thi·∫øu th·ªùi gian ƒë·ªÉ nghi√™n c·ª©u v√† t√¨m hi·ªÉu v·ªÅ ƒë·ªÅ t√†i. |
| Nguy·ªÖn Anh Tu·∫•n - 21133113      | T√¨m ki·∫øm t·∫≠p d·ªØ li·ªáu, khai pha d·ªØ li·ªáu, ph√¢n t√≠ch th√¥ng tin chi ti·∫øt v·ªÅ c√°c danh m·ª•c s·∫£n ph·∫©m (X√°c ƒë·ªãnh danh m·ª•c s·∫£n ph·∫©m, m√£ h√≥a d·ªØ li·ªáu, ph√¢n c·ª•m s·∫£n ph·∫©m- cluster, V·∫Ω bi·ªÉu ƒë·ªì WordCould). S·ª≠ d·ª•ng model Random Forest ƒë·ªÉ ph√¢n lo·∫°i kh√°ch h√†ng.                                                                         | 100%              | T√≠ch c·ª±c ho√†n th√†nh ƒë√∫ng th·ªùi gian v√† c√°c nhi·ªám v·ª• ƒë∆∞·ª£c giao, c√≥ nhi·ªÅu √Ω ki·∫øn ƒë√≥ng g√≥p cho ƒë·ªÅ t√†i c·ªßa nh√≥m. | Do th·ªùi gian h·∫°n ch·∫ø n√™n c√≤n m·ªôt s·ªë sai s√≥t nh·∫•t ƒë·ªãnh, Thi·∫øu th·ªùi gian ƒë·ªÉ nghi√™n c·ª©u v√† t√¨m hi·ªÉu v·ªÅ ƒë·ªÅ t√†i. |
